<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC P2P Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    textarea { width: 100%; height: 120px; margin: 5px 0; padding: 5px; resize: none; }
    input { width: calc(100% - 90px); padding: 5px; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; border-radius: 6px; }
    #messages { height: 150px; }
    .row { display: flex; align-items: center; gap: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC Frontend-Only Chat</h2>

  <button onclick="createOffer()">Create Offer</button>
  <button onclick="acceptRemote()">Accept Remote</button>

  <h3>Local Description</h3>
  <div class="row">
    <textarea id="localDesc" readonly></textarea>
    <button onclick="copyLocal()">ðŸ“‹ Copy</button>
  </div>

  <h3>Remote Description</h3>
  <div class="row">
    <textarea id="remoteDesc"></textarea>
    <button onclick="pasteRemote()">ðŸ“¥ Paste</button>
  </div>

  <h3>Chat</h3>
  <textarea id="messages" readonly></textarea><br>
  <div class="row">
    <input id="input" placeholder="Type a message" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    let pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    let channel;
    const localDesc = document.getElementById("localDesc");
    const remoteDesc = document.getElementById("remoteDesc");
    const messages = document.getElementById("messages");
    const input = document.getElementById("input");

    // show remote messages
    pc.ondatachannel = (event) => {
      channel = event.channel;
      channel.onmessage = (e) => {
        messages.value += "Peer: " + e.data + "\n";
      };
    };

    // wait for ICE candidates
    async function waitForICE() {
      await new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          resolve();
        } else {
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              resolve();
            }
          };
        }
      });
    }

    async function createOffer() {
      channel = pc.createDataChannel("chat");
      channel.onmessage = (e) => {
        messages.value += "Peer: " + e.data + "\n";
      };

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await waitForICE();
      localDesc.value = JSON.stringify(pc.localDescription);
    }

    async function acceptRemote() {
      let desc = JSON.parse(remoteDesc.value);
      await pc.setRemoteDescription(desc);

      if (desc.type === "offer") {
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await waitForICE();
        localDesc.value = JSON.stringify(pc.localDescription);
      }
    }

    function sendMessage() {
      if (channel && input.value) {
        channel.send(input.value);
        messages.value += "Me: " + input.value + "\n";
        input.value = "";
      }
    }

    // Clipboard helpers
    async function copyLocal() {
      try {
        await navigator.clipboard.writeText(localDesc.value);
        alert("Local Description copied!");
      } catch (err) {
        alert("Failed to copy: " + err);
      }
    }

    async function pasteRemote() {
      try {
        remoteDesc.value = await navigator.clipboard.readText();
        alert("Remote Description pasted!");
      } catch (err) {
        alert("Failed to paste: " + err);
      }
    }
  </script>
</body>
</html>
