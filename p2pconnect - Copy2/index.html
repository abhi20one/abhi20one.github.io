<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC P2P Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 120px; margin: 5px 0; padding: 5px; }
    input { width: 80%; padding: 5px; }
    button { padding: 8px 12px; margin: 5px; }
    #messages { height: 150px; }
  </style>
</head>
<body>
  <h2>WebRTC Frontend-Only Chat</h2>

  <button onclick="createOffer()">Create Offer</button>
  <button onclick="acceptRemote()">Accept Remote</button>

  <h3>Local Description (copy this)</h3>
  <textarea id="localDesc" readonly></textarea>

  <h3>Remote Description (paste here)</h3>
  <textarea id="remoteDesc"></textarea>

  <h3>Chat</h3>
  <textarea id="messages" readonly></textarea><br>
  <input id="input" placeholder="Type a message" />
  <button onclick="sendMessage()">Send</button>

  <script>
    let pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    let channel;
    const localDesc = document.getElementById("localDesc");
    const remoteDesc = document.getElementById("remoteDesc");
    const messages = document.getElementById("messages");
    const input = document.getElementById("input");

    // show remote messages
    pc.ondatachannel = (event) => {
      channel = event.channel;
      channel.onmessage = (e) => {
        messages.value += "Peer: " + e.data + "\n";
      };
    };

    // add ICE candidates into the local description automatically
    async function waitForICE() {
      await new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          resolve();
        } else {
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              resolve();
            }
          };
        }
      });
    }

    async function createOffer() {
      channel = pc.createDataChannel("chat");
      channel.onmessage = (e) => {
        messages.value += "Peer: " + e.data + "\n";
      };

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await waitForICE();
      localDesc.value = JSON.stringify(pc.localDescription);
    }

    async function acceptRemote() {
      let desc = JSON.parse(remoteDesc.value);
      await pc.setRemoteDescription(desc);

      if (desc.type === "offer") {
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await waitForICE();
        localDesc.value = JSON.stringify(pc.localDescription);
      }
    }

    function sendMessage() {
      if (channel && input.value) {
        channel.send(input.value);
        messages.value += "Me: " + input.value + "\n";
        input.value = "";
      }
    }
  </script>
</body>
</html>
